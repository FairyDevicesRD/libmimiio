# mimiio_tumbler_ex3

## はじめに

### 概要

Fairy I/O Tumbler 上で、libmimixfe と組み合わせ（機能制限有）、録音及び信号処理された音声を入力として、リアルタイムでリモートホストに送信し、リアルタイムでリモートホストから認識結果を受信する最もシンプルなサンプルプログラムです。サンプルプログラムの単純化のために、機能制限として、libmimixfe の設定上、同時検出する音源数が 1 の場合のみに対応し、同時複数音源を抽出する設定になっている場合には利用することができません。

このサンプルプログラムでは、ex2 と同様に libmimixfe の VAD の結果を利用します。 ex2 とは異なり、libmimiio の結果受信コールバック関数からの結果をユーザープログラム側にブロッキングキューで引き出し、JSON 形式の結果を解釈し、何らかのユーザープログラム処理を行う例示を行っています。

また、VAD により発話終了が検出された時点で、音声サインを再生する例と、ユーザープログラム側で、最終認識結果を利用して何らかの処理（通信など）を行っている間に、LED リングの光り方を変える例を合わせて示しています。

### 全体動作フロー

1. プログラムが開始される
2. コマンドライン引数を解析する
3. libmimixfe により、XFERecorder を構築し、録音及び信号処理を開始する
4. ユーザープログラムを開始する
5. libmimixfe の VAD により発話開始が検出された時点で、libmimiio によりリモートホストへの接続を開き、WebSocket 通信を開始する
6. 各種コールバック関数によって、録音及び信号処理された音声が適切にリモートホストに送信され、結果が受信される
7. 結果はユーザープログラム側にも適宜渡される
8. libmimixfe の VAD により発話終了が検出された時点で、libmimiio によりリモートホストに最終結果を得るための命令（`recog-break` 命令）が送信される。
9. この時点で音声サインが再生され、LED リングの光り方が変わる
10. 最終結果が受信される
11. ユーザープログラム側で最終結果を利用して何らかの処理をする（本サンプルプログラムでは単に `sleep(2)` している）
12. LED リングの光り方が元に戻る
13. 5 から 12 を任意回数繰り返す
14. Ctrl+C の入力により、全体が終了する

### コマンドライン引数

[mimiio_tumbler_ex1 該当箇所](https://github.com/FairyDevicesRD/libmimiio/tree/master/examples/mimiio_tumbler/mimiio_tumbler_ex1#%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%83%A9%E3%82%A4%E3%83%B3%E5%BC%95%E6%95%B0) と同様です。 pretty_print.py も使えます。

## 主要部解説

このサンプルプログラムでも動作しますが、設計が分かりにくい部分を解消するために一部変更を予定しています。主要部解説は、変更後に掲載します。





